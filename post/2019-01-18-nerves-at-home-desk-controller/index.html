<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Nerves At Home: Controlling a Desk - Embedded Elixir</title>
  <meta name="description" content="Because who doesn&#39;t want to control random things around them using nerves?">
  <meta name="author" content="Curated by Frank Hunleth"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Embedded Elixir",
    
    "url": "https:\/\/embedded-elixir.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/embedded-elixir.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/post\/2019-01-18-nerves-at-home-desk-controller\/",
          "name": "Nerves at home controlling a desk"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Jon Carstens"
  },
  "headline": "Nerves At Home: Controlling a Desk",
  "description" : "Use Nerves and a little reverse engineering to control a motorized desk. Then intercept current height messages from the controller and publish to a Phoenix site for real-time desk height measurements\u0026hellip;because #yolo.\n",
  "inLanguage" : "en",
  "wordCount":  1557 ,
  "datePublished" : "2019-01-18T00:00:00",
  "dateModified" : "2019-01-18T00:00:00",
  "image" : "https:\/\/embedded-elixir.com\/images\/logo.png",
  "keywords" : [ "nerves, elixir, uart, logic analyzer, elixir-circuits, gpio" ],
  "mainEntityOfPage" : "https:\/\/embedded-elixir.com\/post\/2019-01-18-nerves-at-home-desk-controller\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/embedded-elixir.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/embedded-elixir.com\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Nerves At Home: Controlling a Desk" />
<meta property="og:description" content="Because who doesn&#39;t want to control random things around them using nerves?">
<meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
<meta property="og:url" content="https://embedded-elixir.com/post/2019-01-18-nerves-at-home-desk-controller/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Embedded Elixir" />

  <meta name="twitter:title" content="Nerves At Home: Controlling a Desk" />
  <meta name="twitter:description" content="Because who doesn&#39;t want to control random things around them using nerves?">
  <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://embedded-elixir.com/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.115.2">
  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://embedded-elixir.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://embedded-elixir.com/css/syntax.css" /><link rel="stylesheet" href="https://embedded-elixir.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16709386-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Newsletter" href="https://nerves-project.org/newsletter">Newsletter</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com/images/logo.png" alt="Embedded Elixir" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Nerves At Home: Controlling a Desk</h1>
              
              
              
                
                  <h2 class="post-subheading">Because who doesn&#39;t want to control random things around them using nerves?</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on January 18, 2019
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Jon Carstens
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Use Nerves and a little reverse engineering to control a motorized desk. Then
intercept current height messages from the controller and publish to a Phoenix
site for real-time desk height measurements&hellip;because #yolo.</p>
<h2 id="the-idea">The idea</h2>
<p>I&rsquo;m fairly obsessed with automating my home and things around me. With nerves,
that has become even easier and much more cost effective. But most of my recent
work has been pretty binary - turning relay on/off, reading a sensor is on/off,
reading the temperature, etc etc. I wanted to branch out a bit and try to
directly interface with an existing component in my house. Something that is
it&rsquo;s own controller and has its own message system.</p>
<p>One day I leaned back to take a break from work, looked over at my <a href="https://www.upliftdesk.com/advanced-digital-memory-keypad/">Uplift Desk
Advanced Digital Memory Keypad</a>
for my sit/stand desk and it hit me - <em>&ldquo;I bet I could control that with nerves&hellip;&rdquo;</em>
🤔</p>
<p>And thus this project was born (albeit useless as it is&hellip;)</p>
<h2 id="interfacing-with-the-desk">Interfacing with the desk</h2>
<p>Mine is a 2-leg model from Uplift Desk which has their standard [Smart Control Box]
(<a href="https://www.upliftdesk.com/desk-control-box-for-2-leg-3-leg-or-4-leg-desks/)">https://www.upliftdesk.com/desk-control-box-for-2-leg-3-leg-or-4-leg-desks/)</a>.
The description states it <em>&ldquo;Houses the &lsquo;brain&rsquo; of your UPLIFT Desk&rdquo;</em> along with
other settings like motor speed, min/max heights, and saved height memory. Which
is great because that means the <a href="https://www.upliftdesk.com/advanced-digital-memory-keypad/">Advanced Digital Memory Keypad</a>
is essentially just a simple microcontroller receiving and sending messages with
&ldquo;the brain&rdquo;, so we can intercept there with the nerves controller.</p>
<p>The keypad connects to the desk controller via a RJ45 jack and looks like a
typical ethernet cable with an 8-wire pinout. So I took apart to see what the
connector looked like for those 8 wires and was pleasantly surprised. The wires
were clearly colored and the PCB had a label for each one so I was able to
immediately identify <code>5V</code>, <code>GND</code>, and <code>G1</code>. The other wire labels were mostly
covered by the connector, but I was able to make out <code>T</code>, <code>R</code>, and <code>G0</code> as well.</p>
<p><img src="/images/2019-01-18/desk_keypad_internals.jpg" alt="desk_keypad_internals"></p>
<p>So I set out with a multimeter to map out the wires as best I could. <code>T</code>/<code>R</code>
were most likely short for <code>Tx</code>/<code>Rx</code> and would be the communication with the
controller, so I skipped those for now. Here&rsquo;s the final pinout I came up with:</p>
<p><img src="/images/2019-01-18/desk_keypad_pinout.png" alt="desk_keypad_pinout"></p>
<p>Moving the desk is simply just connecting the yellow or green wire to GND. So that
can be easily done by toggling a GPIO pin between <em>HIGH (1)</em> and <em>LOW (0)</em> using
<a href="https://github.com/elixir-circuits/circuits_gpio">Circuits.GPIO</a>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># setting LOW will move the desk in whatever direction the pin is for</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Be sure to initialize with HIGH to prevent moving on pin open.</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">up_pin</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="mi">23</span><span class="p">,</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">initial_value</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">down_pin</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">initial_value</span><span class="p">:</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># set LOW to move up and back down</span>
</span></span><span class="line"><span class="cl"><span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">up_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># start moving</span>
</span></span><span class="line"><span class="cl"><span class="ss">:timer</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">up_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># stop moving</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">down_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># start moving</span>
</span></span><span class="line"><span class="cl"><span class="ss">:timer</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">down_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># stop moving</span>
</span></span></code></pre></div><h2 id="reading-the-messages">Reading the messages</h2>
<p>Now comes the fun part and ultimate goal of this project: reading the messages
from the controller for the current height.</p>
<p>Initially, I connected the <code>Tx</code>(white) and <code>Rx</code>(brown) wires to my computer via
<a href="https://www.adafruit.com/product/954">USB to TTL serial cable</a> I had around and
used <code>screen</code> in my terminal to see what these messages would even look like.
It was just jibberish and repeating characters, but at least there were
messages!  I tried lots of different baud rates thinking maybe thats was causing
the garbled mess, but I&rsquo;m not really proficient with <code>screen</code> and serial
communication so I gave up there.</p>
<p>Instead I decided to connect the wires to the corresponding UART pins on my rpi3
and used yet another fancy library,
<a href="https://github.com/elixir-circuits/circuits_gpio">Circuits.UART</a>.  From there,
I could open UART port and see if I get better messages there.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">uart</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.UART</span><span class="o">.</span><span class="n">start_link</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Open UART to send messages to current process</span>
</span></span><span class="line"><span class="cl"><span class="ss">:ok</span> <span class="o">=</span> <span class="nc">Circuits.UART</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># Move the desk a little bit and flush the messages</span>
</span></span><span class="line"><span class="cl"><span class="n">flush</span>
</span></span></code></pre></div><p>This exploded with messages!</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">255</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">0</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">253</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">0</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">254</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">5</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">0</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="n">...</span><span class="c1"># repeated x100</span>
</span></span></code></pre></div><p>It was a bit overwhelming and confusing. There were hundreds of messages for just
simple movements and I was having trouble finding a pattern. I ended up pinging
the always helpful folks in the <a href="https://elixir-lang.slack.com/messages/C0AB4A879/">Nerves slack channel</a>
which ultimately advised me to get a logic analyzer to look at the messages (the <a href="https://elixirforum.com/c/nerves-forum">Nerves Forum</a>
is also a great place to get help). Specifically, I got the one from <a href="https://www.saleae.com">Saleae</a>.
Once that was wired up, I still got the same binary messages, in groups of 4 bytes.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-text" data-lang="text"><span class="line"><span class="cl">1, 1, 0, 253
</span></span><span class="line"><span class="cl">1, 1, 0, 253
</span></span><span class="line"><span class="cl">1, 1, 0, 254
</span></span><span class="line"><span class="cl">1, 1, 0, 255
</span></span><span class="line"><span class="cl">1, 1, 1, 0
</span></span></code></pre></div><p>Then it clicked: Serial data can be framed differently. <em>And</em> <code>Circuits.UART</code> can
handle framing. <em>And</em> there is a <a href="https://github.com/elixir-circuits/circuits_uart/blob/master/lib/uart/framing/fourbyte.ex">Circuits.UART.Framing.FourByte</a>
module to handle this exact case. So really, I didn&rsquo;t need a full blown logic
analyzer 🤦‍♂. Next time I&rsquo;ll need it 😉&hellip;</p>
<p>So now that I can frame it, we just need to decipher what it means. I&rsquo;ll save
you the trouble. It&rsquo;s actually a lot simpler than I thought&hellip;</p>
<p><img src="/images/2019-01-18/desk_bytes_breakdown.png" alt="desk_bytes_breakdown"></p>
<p>The height is the result of <code>Base height indicator + Current Height</code> and converting
to a number with 1 decimal place. So this heigh would be <code>0 + 255 = 25.5 inches</code>.
My desk can go up to 50.0 inches in height, but the largest decimal number you can
represent in 8 bits is 255. Thats where the <code>Base Height Indicator</code> comes in. If
that is <code>1</code>, then the base height is <code>256</code> (or <code>255 + 1</code>).</p>
<p>In fact, this concept is called <a href="https://en.wikipedia.org/wiki/Endianness">endianness</a>
which describes the order bytes are arranged into large numerical values when
transmitted. Specifically, this is <a href="https://en.wikipedia.org/wiki/Endianness#Big-endian">big-endian</a>
since the most significant byte is at the end of the address. (Big thanks to
<a href="https://twitter.com/fhunleth?lang=en">Frank Hunleth</a> for <a href="https://github.com/fhunleth/embedded-elixir/pull/23#issuecomment-455712932">pointing out this TIL gem</a>)</p>
<p>With this, we can now easily calculate height from the messages like so:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">253</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 0 + 253 = 253 or 25.3 as decimal</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1 + 255 + 0 = 256 or 25.6</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">53</span><span class="p">&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="c1"># 1 + 255 + 53 = 309 or 30.9</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1"># We can also match the last 2 bytes to get the big-endian value</span>
</span></span><span class="line"><span class="cl"><span class="c1"># then divide by 10 to get the float</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">16</span><span class="p">)&gt;&gt;}</span>
</span></span><span class="line"><span class="cl"><span class="mf">30.6</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="mi">10</span>
</span></span></code></pre></div><p>Now we can put that all together in a nice little GenServer module to handle the
height messages we care about and ignore all others. Then calculate the current
height and report it somewhere:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">Controller.Reader</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">GenServer</span>
</span></span><span class="line"><span class="cl">  <span class="kn">alias</span> <span class="nc">Circuits.UART</span>
</span></span><span class="line"><span class="cl">  <span class="kn">require</span> <span class="nc">Logger</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="ow">when</span> <span class="n">is_list</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="n">start_link</span><span class="p">(</span><span class="nc">Map</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="n">state</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="ow">when</span> <span class="n">is_map</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
</span></span><span class="line"><span class="cl">            <span class="o">|&gt;</span> <span class="nc">Map</span><span class="o">.</span><span class="n">put_new</span><span class="p">(</span><span class="ss">:port</span><span class="p">,</span> <span class="s2">&#34;ttyAMA0&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">            <span class="o">|&gt;</span> <span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="ss">:current_height</span><span class="p">,</span> <span class="s2">&#34;25.3&#34;</span><span class="p">)</span> <span class="c1"># Arbitrary default height (my current minimum allowed height)</span>
</span></span><span class="line"><span class="cl">    <span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">__MODULE__</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="ss">name</span><span class="p">:</span> <span class="n">__MODULE__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">init</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">send</span> <span class="n">self</span><span class="p">(),</span> <span class="ss">:init</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:init</span><span class="p">,</span> <span class="p">%{</span><span class="ss">port</span><span class="p">:</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">uart</span><span class="p">}</span> <span class="o">=</span> <span class="nc">UART</span><span class="o">.</span><span class="n">start_link</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span> <span class="o">=</span> <span class="nc">UART</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">uart</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="ss">framing</span><span class="p">:</span> <span class="nc">UART.Framing.FourByte</span><span class="p">,</span> <span class="ss">rx_framing_timeout</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="nc">Map</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="ss">:uart</span><span class="p">,</span> <span class="n">uart</span><span class="p">)}</span> <span class="c1"># just for reference</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">height</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">16</span><span class="p">)&gt;&gt;},</span> <span class="p">%{</span><span class="ss">port</span><span class="p">:</span> <span class="n">port</span><span class="p">}</span> <span class="o">=</span> <span class="n">state</span><span class="p">)</span> <span class="ow">when</span> <span class="n">name</span> <span class="o">==</span> <span class="n">port</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># converts the 16-bit big-endian integer to the height as a float</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># i.e. 306 / 10 = 30.6</span>
</span></span><span class="line"><span class="cl">    <span class="n">new_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">10</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1"># We could could lots of messages with the same height, so only report changes here</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">new_height</span> <span class="o">!=</span> <span class="n">state</span><span class="o">.</span><span class="n">current_height</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="nc">Logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">new_height</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># This is where I report, but commenting out so it can compile for you</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># send Controller.Reporter, {:height_update, new_height}</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="p">%{</span><span class="n">state</span> <span class="o">|</span> <span class="ss">current_height</span><span class="p">:</span> <span class="n">new_height</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1"># ignore messages we don&#39;t care about</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_info</span><span class="p">({</span><span class="ss">:circuits_uart</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">},</span> <span class="n">state</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="n">state</span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h2 id="publish-it">Publish it</h2>
<p>The world obviously wants to know the current height of my desk, so I also made
a website that my controller reports to anytime there is a height change. The
site uses <a href="https://phoenixframework.org">Phoenix</a> to handle websocket
connections with the controller and browser sessions, and
<a href="https://github.com/grych/drab">Drab</a> to update the view in real time on the
backend when the socket reports height change.  You can see the reporting code
at
<a href="https://github.com/jjcarstens/desk/blob/master/controller/lib/controller/reporter.ex">here</a>.</p>
<p>It&rsquo;s not special, but you can check it out at: <a href="https://dudewheresmydesk.live">https://dudewheresmydesk.live</a></p>
<h2 id="fin">Fin</h2>
<p>To finish, I broke this all out into a breadboard and wired to keypad as well as
the rpi3 controller so I could still use both options.</p>
<p><img src="/images/2019-01-18/desk_all_connected.jpg" alt="desk_all_connected.jpg"></p>
<p>All of the code for the controller and website is available at
<a href="https://github.com/jjcarstens/desk">github.com/jjcarstens/desk</a> if you want to
try yourself.</p>
<p>There&rsquo;s really not much use-case for this, but it was definitely fun. My hope is
that it helps remove some fear of working with hardware and encourage others to
take the dive and try it out. There are lots of fun projects to do in hardware
and nerves help make that a little easier.</p>
<p>I&rsquo;ve got quite a few more projects for <em>Nerves at Home</em>, so if you liked this
then keep on the lookout for more to come.</p>
<p>Also, feel free to reach out if you want to collaborate on fun <em>Nerves at Home</em>
projects. Or join us at <a href="https://twitter.com/NervesMeetup">Nerves Remote Meetup</a>
where we basically just talk about random hardware projects we&rsquo;re all working on
and pass around ideas.</p>
<p>Until then&hellip; 🎉 🍹 🌴 👋</p>

        
          <div class="blog-tags">
            
              <a href="https://embedded-elixir.com//tags/nerves/">nerves</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/elixir/">elixir</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/uart/">uart</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/logic-analyzer/">logic analyzer</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/elixir-circuits/">elixir-circuits</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/gpio/">gpio</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://embedded-elixir.com/post/2018-12-10-using-distribution-to-test-hardware/" data-toggle="tooltip" data-placement="top" title="Using Erlang Distribution to test hardware">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://embedded-elixir.com/post/2019-05-18-talking-i2c/" data-toggle="tooltip" data-placement="top" title="Talking I2C">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Curated by Frank Hunleth
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.115.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://embedded-elixir.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://embedded-elixir.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

