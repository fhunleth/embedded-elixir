<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Mocks and Explicit Contracts in Nerves - Embedded Elixir</title>
  <meta name="description" content="If you are not super new to Elixir, you may have read this blog
post
by José Valim. If you haven&rsquo;t read it, you may want to check it out. This post
references it frequently.
Nerves puts a lot of focus into spending as much time developing your
application on your host machine. This means you can rapidly develop your
application, write tests, etc. When you feel it is ready you can then burn your
firmware to a device and it will just work. This has an issue though.">
  <meta name="author" content="Curated by Frank Hunleth"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Embedded Elixir",
    
    "url": "https:\/\/embedded-elixir.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/embedded-elixir.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/post\/2018-09-25-mocks-and-explicit-contracts-expansion\/",
          "name": "Mocks and explicit contracts in nerves"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Connor Rigby"
  },
  "headline": "Mocks and Explicit Contracts in Nerves",
  "description" : "If you are not super new to Elixir, you may have read this blog post by José Valim. If you haven\u0026rsquo;t read it, you may want to check it out. This post references it frequently.\nNerves puts a lot of focus into spending as much time developing your application on your host machine. This means you can rapidly develop your application, write tests, etc. When you feel it is ready you can then burn your firmware to a device and it will just work. This has an issue though.\n",
  "inLanguage" : "en",
  "wordCount":  845 ,
  "datePublished" : "2018-09-25T00:00:00",
  "dateModified" : "2018-09-25T00:00:00",
  "image" : "https:\/\/embedded-elixir.com\/images\/logo.png",
  "keywords" : [ "nerves, mock, stub" ],
  "mainEntityOfPage" : "https:\/\/embedded-elixir.com\/post\/2018-09-25-mocks-and-explicit-contracts-expansion\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/embedded-elixir.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/embedded-elixir.com\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Mocks and Explicit Contracts in Nerves" />
<meta property="og:description" content="If you are not super new to Elixir, you may have read this blog
post
by José Valim. If you haven&rsquo;t read it, you may want to check it out. This post
references it frequently.
Nerves puts a lot of focus into spending as much time developing your
application on your host machine. This means you can rapidly develop your
application, write tests, etc. When you feel it is ready you can then burn your
firmware to a device and it will just work. This has an issue though.">
<meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
<meta property="og:url" content="https://embedded-elixir.com/post/2018-09-25-mocks-and-explicit-contracts-expansion/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Embedded Elixir" />

  <meta name="twitter:title" content="Mocks and Explicit Contracts in Nerves" />
  <meta name="twitter:description" content="If you are not super new to Elixir, you may have read this blog
post
by José Valim. If you haven&rsquo;t read it, you may want to check it out. This post
references it frequently.
Nerves puts a lot of …">
  <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://embedded-elixir.com/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.115.2">
  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://embedded-elixir.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://embedded-elixir.com/css/syntax.css" /><link rel="stylesheet" href="https://embedded-elixir.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16709386-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Newsletter" href="https://nerves-project.org/newsletter">Newsletter</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com/images/logo.png" alt="Embedded Elixir" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Mocks and Explicit Contracts in Nerves</h1>
              
              
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on September 25, 2018
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Connor Rigby
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>If you are not super new to Elixir, you may have read <a href="http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/">this blog
post</a>
by José Valim. If you haven&rsquo;t read it, you may want to check it out. This post
references it frequently.</p>
<p>Nerves puts a lot of focus into spending as much time developing your
application on your host machine. This means you can rapidly develop your
application, write tests, etc. When you feel it is ready you can then burn your
firmware to a device and it will <em>just work</em>. This has an issue though.</p>
<p>Sometimes your application may interact with something in the real world that
your development pc probably won&rsquo;t have access to. Enter: a mock. Elixir makes
this really easy to implement. You simply define a generic behaviour that an
implementation must follow. This allows your host machine to have a single
implementation that will <em>always</em> work, not work at all, throw an exception,
etc.</p>
<h2 id="case-study-elixirale">Case study: ElixirALE</h2>
<p>José&rsquo;s post above had a small example on how one would
&ldquo;mock&rdquo; an external API. We can do the same thing, but for Nerves.</p>
<p>Imagine you want to do a simple task: turn a light on. An Elixir application
that can accomplish this is
<a href="https://github.com/fhunleth/elixir_ale">ElixirALE</a>.  It has a simple API.
Eventually you will do something like:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="c1"># Start a GPIO GenServer</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="nc">ElixirAle.GPIO</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="ss">:output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># Turn the pin _ON_</span>
</span></span><span class="line"><span class="cl"><span class="ss">:ok</span> <span class="o">=</span> <span class="nc">GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span></code></pre></div><p>And all is great. But you want to do your development on your PC right?  Well
the light isn&rsquo;t connected to your PC at all? One common practice as José points
out is to <code>mock</code> (the verb!) the GPIO GenServer.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="n">mock</span><span class="p">(</span><span class="nc">ElixirAle.GPIO</span><span class="p">,</span> <span class="ss">:start_link</span><span class="p">,</span> <span class="ss">to_return</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">})</span>
</span></span><span class="line"><span class="cl"><span class="n">mock</span><span class="p">(</span><span class="nc">ElixirAle.GPIO</span><span class="p">,</span> <span class="ss">:write</span><span class="p">,</span> <span class="ss">to_return</span><span class="p">:</span> <span class="ss">:ok</span><span class="p">)</span>
</span></span></code></pre></div><p>But there is a better way! Let&rsquo;s define a more usable way of setting this up.
What do you <em>really</em> want to do? You don&rsquo;t specifically want to toggle pin 18,
you want to turn a light on. Lets write a <code>behaviour</code> for this.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">MyApp.Light</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@opaque</span> <span class="n">private</span> <span class="o">::</span> <span class="n">term</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@doc</span> <span class="s2">&#34;initialize the light&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">@callback</span> <span class="n">init</span><span class="p">(</span><span class="n">opts</span> <span class="o">::</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">t</span><span class="p">())</span> <span class="o">::</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">private</span><span class="p">}</span> <span class="o">|</span> <span class="ss">:error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@doc</span> <span class="s2">&#34;Callback to turn the light on&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">@callback</span> <span class="n">on</span><span class="p">(</span><span class="n">private</span><span class="p">)</span> <span class="o">::</span> <span class="ss">:ok</span> <span class="o">|</span> <span class="ss">:error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@doc</span> <span class="s2">&#34;Callback to turn the light off&#34;</span>
</span></span><span class="line"><span class="cl">  <span class="na">@callback</span> <span class="n">off</span><span class="p">(</span><span class="n">private</span><span class="p">)</span> <span class="o">::</span> <span class="ss">:ok</span> <span class="o">|</span> <span class="ss">:error</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">GenServer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@args</span> <span class="nc">Application</span><span class="o">.</span><span class="n">get_env</span><span class="p">(</span><span class="ss">:my_app</span><span class="p">,</span> <span class="n">__MODULE__</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">on</span><span class="p">(</span><span class="n">pid</span> <span class="p">\\</span> <span class="n">__MODULE__</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:on</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">off</span><span class="p">(</span><span class="n">pid</span> <span class="p">\\</span> <span class="n">__MODULE__</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">GenServer</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="ss">:off</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">start_link</span><span class="p">(</span><span class="n">args</span> <span class="p">\\</span> <span class="na">@args</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[</span><span class="ss">name</span><span class="p">:</span> <span class="n">__MODULE__</span><span class="p">])</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">GenServer</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">__MODULE__</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">impl</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="ss">:implementation</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">priv</span><span class="p">}</span> <span class="o">=</span> <span class="n">impl</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">impl</span><span class="p">:</span> <span class="n">impl</span><span class="p">,</span> <span class="ss">priv</span><span class="p">:</span> <span class="n">priv</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_cast</span><span class="p">(</span><span class="ss">:on</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">on</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">priv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_cast</span><span class="p">(</span><span class="ss">:off</span><span class="p">,</span> <span class="n">state</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span> <span class="o">=</span> <span class="n">state</span><span class="o">.</span><span class="n">impl</span><span class="o">.</span><span class="n">off</span><span class="p">(</span><span class="n">state</span><span class="o">.</span><span class="n">priv</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>The <code>@callback</code> lines are the important things here. This defines a
<code>@behaviour</code> that new implementation can follow. Lets start with our
development host implementation that simply logs the changes to the console.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">MyApp.HostLightImpl</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@behaviour</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kn">require</span> <span class="nc">Logger</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">init</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="ss">:off</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">off</span><span class="p">(</span><span class="ss">:off</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">off</span><span class="p">(</span><span class="ss">:on</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;changing light from :on to :off&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">on</span><span class="p">(</span><span class="ss">:on</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">on</span><span class="p">(</span><span class="ss">:off</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;changing light from :off to :on&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>And <em>finally</em>, lets build the real implementation.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">MyApp.ElixirAleLightImpl</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@behaviour</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kn">require</span> <span class="nc">Logger</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">init</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">pin</span> <span class="o">=</span> <span class="nc">Keyword</span><span class="o">.</span><span class="n">fetch!</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="ss">:pin</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="nc">ElixirAle.GPIO</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="ss">:output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%{</span><span class="ss">pid</span><span class="p">:</span> <span class="n">pid</span><span class="p">,</span> <span class="ss">pin</span><span class="p">:</span> <span class="n">pin</span><span class="p">,</span> <span class="ss">state</span><span class="p">:</span> <span class="ss">:off</span><span class="p">}}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">off</span><span class="p">(%{</span><span class="ss">state</span><span class="p">:</span> <span class="ss">:off</span><span class="p">}),</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">off</span><span class="p">(</span><span class="ss">:on</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;changing light from :on to :off&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nc">ElixirAle.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@impl</span> <span class="nc">MyApp.Light</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">on</span><span class="p">(%{</span><span class="ss">state</span><span class="p">:</span> <span class="ss">:on</span><span class="p">}),</span> <span class="ss">do</span><span class="p">:</span> <span class="ss">:ok</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">on</span><span class="p">(</span><span class="ss">:off</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Logger</span><span class="o">.</span><span class="n">debug</span> <span class="s2">&#34;changing light from :off to :on&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="nc">ElixirAle.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><h2 id="conditional-implementation-and-compilation">Conditional Implementation and Compilation</h2>
<p>Now that there are two different implementations, you will need to decide
how/when each of them are compiled and used. Deciding which one to use can be
as simple as using <code>Mix.Config</code>.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kn">use</span> <span class="nc">Mix.Config</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">case</span> <span class="nc">Mix.Project</span><span class="o">.</span><span class="n">config</span><span class="p">()[</span><span class="ss">:target</span><span class="p">]</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;host&#34;</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="ss">:my_app</span><span class="p">,</span> <span class="nc">MyApp.Light</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="ss">implementation</span><span class="p">:</span> <span class="nc">MyApp.HostLightImpl</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="s2">&#34;rpi0&#34;</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="n">config</span> <span class="ss">:my_app</span><span class="p">,</span> <span class="nc">MyApp.Light</span><span class="p">,</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="ss">implementation</span><span class="p">:</span> <span class="nc">MyApp.ElixirAleLightImpl</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="ss">pin</span><span class="p">:</span> <span class="mi">18</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>The last thing you may have issues with is loading the dependency. In your
<code>mix.exs</code> file, you will probably have:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">def</span> <span class="n">deps</span><span class="p">(</span><span class="s2">&#34;host&#34;</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">[]</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">def</span> <span class="n">deps</span><span class="p">(</span><span class="n">_target</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="p">[</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:elixir_ale</span><span class="p">,</span> <span class="s2">&#34;~&gt; 1.0&#34;</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>This means the <code>MyApp.ElixirAleLightImpl</code> module will give compiler warnings or
even errors when compiling on the <code>host</code> environment.  What I like to do to
solve this is create a directory called <code>platform</code> or similar in the root of my
<code>mix.exs</code> and tweak the <code>elixirc_paths</code> option.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">project</span><span class="p">()</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">[</span>
</span></span><span class="line"><span class="cl">      <span class="ss">app</span><span class="p">:</span> <span class="ss">:my_app</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="ss">target</span><span class="p">:</span> <span class="na">@target</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">      <span class="ss">elixirc_paths</span><span class="p">:</span> <span class="n">elixirc_paths</span><span class="p">(</span><span class="na">@target</span><span class="p">),</span> <span class="c1"># Add this line.</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">elixirc_paths</span><span class="p">(</span><span class="s2">&#34;host&#34;</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;lib&#34;</span><span class="p">,</span> <span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;platform&#34;</span><span class="p">,</span> <span class="s2">&#34;host&#34;</span><span class="p">)]</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">elxiirc_paths</span><span class="p">(</span><span class="n">_target</span><span class="p">),</span> <span class="ss">do</span><span class="p">:</span> <span class="p">[</span><span class="s2">&#34;lib&#34;</span><span class="p">,</span> <span class="nc">Path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&#34;platform&#34;</span><span class="p">,</span> <span class="s2">&#34;target&#34;</span><span class="p">)]</span>
</span></span></code></pre></div><p>Now you can store the <code>MyApp.ElixirAleLightImpl</code> file inside the
<code>platform/target</code> dir, and <code>MyApp.HostLightImpl</code> in the <code>platform/host</code> dir.</p>
<h2 id="summing-up">Summing Up</h2>
<p>You can keep your Nerves application concerns separated and clean by using
Elixir <code>@behaviour</code>s and explicit contracts. Something not discussed in depth
in the short post is testing with Nerves. This deserves a post all in it&rsquo;s own,
but mocks and contracts as described here is a huge part of writing tests for
Nerves devices.</p>

        
          <div class="blog-tags">
            
              <a href="https://embedded-elixir.com//tags/nerves/">nerves</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/mock/">mock</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/stub/">stub</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://embedded-elixir.com/post/2018-06-15-serial_number/" data-toggle="tooltip" data-placement="top" title="Provisioning Nerves Devices">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://embedded-elixir.com/post/2018-12-10-heart/" data-toggle="tooltip" data-placement="top" title="You Gotta Have Heart">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Curated by Frank Hunleth
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.115.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://embedded-elixir.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://embedded-elixir.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

