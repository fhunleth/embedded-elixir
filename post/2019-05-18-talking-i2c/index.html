<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Talking I2C - Embedded Elixir</title>
  <meta name="description" content="How to communicate with sensors and low-level chips">
  <meta name="author" content="Curated by Frank Hunleth"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Embedded Elixir",
    
    "url": "https:\/\/embedded-elixir.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/embedded-elixir.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/post\/2019-05-18-talking-i2c\/",
          "name": "Talking i2 c"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Michael Ries"
  },
  "headline": "Talking I2C",
  "description" : "Reading datasheets for fun and profit, or how I learned to stop worrying and convert analog signals into elixir terms.\n",
  "inLanguage" : "en",
  "wordCount":  980 ,
  "datePublished" : "2019-05-18T00:00:00",
  "dateModified" : "2019-05-18T00:00:00",
  "image" : "https:\/\/embedded-elixir.com\/images\/logo.png",
  "keywords" : [ "nerves, elixir, i2c, binary, elixir-circuits, ASD1115" ],
  "mainEntityOfPage" : "https:\/\/embedded-elixir.com\/post\/2019-05-18-talking-i2c\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/embedded-elixir.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/embedded-elixir.com\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Talking I2C" />
<meta property="og:description" content="How to communicate with sensors and low-level chips">
<meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
<meta property="og:url" content="https://embedded-elixir.com/post/2019-05-18-talking-i2c/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Embedded Elixir" />

  <meta name="twitter:title" content="Talking I2C" />
  <meta name="twitter:description" content="How to communicate with sensors and low-level chips">
  <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://embedded-elixir.com/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.115.2">
  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://embedded-elixir.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://embedded-elixir.com/css/syntax.css" /><link rel="stylesheet" href="https://embedded-elixir.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16709386-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Newsletter" href="https://nerves-project.org/newsletter">Newsletter</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com/images/logo.png" alt="Embedded Elixir" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Talking I2C</h1>
              
              
              
                
                  <h2 class="post-subheading">How to communicate with sensors and low-level chips</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on May 18, 2019
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Michael Ries
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Reading datasheets for fun and profit, or how I learned to stop worrying and
convert analog signals into elixir terms.</p>
<h2 id="watering-my-plants">Watering My Plants</h2>
<p>I want to have a plant on my desk at work, but each time I bring one to the office it promptly dies.
Technology is clearly the solution to my problem.
I need to be told when to water my plants, or even better, have them water themselves.
We&rsquo;ll start with a soil moisture sensor.</p>
<p><img src="/images/2019-05-18/capacitive_sensor.jpg" alt="capacitive soil sensor"></p>
<blockquote>
<p>Photo courtesy of <a href="http://wiki.seeedstudio.com/Grove-Capacitive_Moisture_Sensor-Corrosion-Resistant/">http://wiki.seeedstudio.com/Grove-Capacitive_Moisture_Sensor-Corrosion-Resistant/</a></p>
</blockquote>
<h2 id="analog-sensors">Analog Sensors</h2>
<p>This sensor has 3 wires.
<code>GND</code> and <code>VCC</code> provide power to the device and the <code>SIG</code> wire will carry a voltage between <code>0</code> and <code>3</code> volts depending on how much moisture is around the sensor.
This is known as an analog interface and is a very simple concept, but if you are using a raspberry pi, it turns out to be a a little tricky to read that value.</p>
<p>All of <a href="https://pinout.xyz/">the pins</a> on the raspberry pi are digital pins meaning that they can only be read as <code>0</code> or <code>1</code> depending on whether the voltage is closer to <code>0</code> or <code>3.3</code> volts.
We will need something that converts the analog signal into a digital signal that the raspberry pi can read.</p>
<p><img src="/images/2019-05-18/ads1115.jpg" alt="ADS1115 Analog to Digital Converter"></p>
<blockquote>
<p>Photo courtesy of <a href="https://www.adafruit.com/product/1085">https://www.adafruit.com/product/1085</a></p>
</blockquote>
<h2 id="analog-to-digital">Analog to Digital</h2>
<p>Analog to digital converters take in an analog signal like the <code>0-3</code> volt signal described above, and turn it into a digital signal.
I&rsquo;m using an <a href="http://www.ti.com/product/ADS1115">ADS1115</a> chip which uses an <a href="https://i2c.info/">i²c interface</a> so that you can read 4 different analog signals with just one pair of wires.
This allows you to read each of the analog signals as a 2-byte value, a number between <code>-32,768</code> and <code>32,767</code>.
The raspberry pi has built-in support for talking to I2C devices, so this is a great option for my use-case.</p>
<h2 id="eye-to-see">Eye to See</h2>
<p>The I2C protocol allows you to have multiple devices connected to the same pair of wires that act as a message bus.
The raspberry pi acts as a master, meaning that it initiates communication.
Each device on the bus has an address, and you always use that address when sending or receiving data.</p>
<p>Because the protocol is so basic, many devices implement a <a href="http://www.ti.com/lit/an/slva704/slva704.pdf">register-based protocol</a>.
Each time you want to send a message to the device, you send a first byte that identifies which register you are writing to and the rest of the bytes are the information you want to write into that register.
If you want to ask for some information you write 1 byte to identify what you are asking about, and then you read a certain number of bytes from that address to get the data you want.</p>
<h2 id="checking-the-soil">Checking the Soil</h2>
<p>The first thing we&rsquo;ll do is check the configuration of the device.
To do this well send 1 byte telling the chip which register we want to sent and then read back 2 bytes (the size of the configuration register).</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">bus</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;i2c-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="ss">:ok</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">133</span><span class="p">,</span> <span class="mi">131</span><span class="p">&gt;&gt;}</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="c1"># I2C also has a convenience method for this</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">133</span><span class="p">,</span> <span class="mi">131</span><span class="p">&gt;&gt;}</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">write_read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="mi">1</span><span class="p">&gt;&gt;,</span> <span class="mi">2</span><span class="p">)</span>
</span></span></code></pre></div><p>We&rsquo;re getting back some data, but what do those bytes mean?
We&rsquo;ll need to take a look at <a href="http://www.ti.com/lit/ds/symlink/ads1115.pdf">the datasheet for the ADS1115</a> chip.
These 16 bits of data tell us 9 different things about how the chip is currently operating.
That&rsquo;s a lot of information packed into the space of just two ascii characters.</p>
<p><img src="/images/2019-05-18/ADS1115_Config_Register.png" alt="Config Register"></p>
<p>Luckily, we can use <a href="https://hexdocs.pm/elixir/Kernel.SpecialForms.html#%3C%3C%3E%3E/1">Elixir&rsquo;s binary pattern matching syntax</a> to pull out this information.
Binary pattern matching allows us to ask for information by expressing how we expect the information to be laid out across the bytes.
No bit-shifting required.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">&lt;&lt;</span> <span class="n">status</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mux</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">_other_stuff</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">&gt;&gt;</span> <span class="o">=</span> <span class="p">&lt;&lt;</span><span class="mi">133</span><span class="p">,</span> <span class="mi">131</span><span class="p">&gt;&gt;</span>
</span></span></code></pre></div><p>We can also similarly build a new binary to write new configuration to the register.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="n">config_bytes</span> <span class="o">=</span> <span class="p">&lt;&lt;</span> <span class="n">status</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">mux</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">other_stuff</span><span class="o">::</span><span class="n">size</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="p">&gt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="n">config_register</span> <span class="o">=</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="p">&lt;&lt;</span><span class="n">config_register</span><span class="p">,</span> <span class="n">config_bytes</span><span class="o">::</span><span class="n">binary</span><span class="p">&gt;&gt;)</span>
</span></span></code></pre></div><h2 id="sharing-what-weve-learned">Sharing What We&rsquo;ve Learned</h2>
<p>The binary pattern matching syntax is really helpful for parsing binary data, but learning which bits do which things still requires some squinting and a datasheet.
So I went ahead and published the <a href="https://hexdocs.pm/ads1115/readme.html">ADS1115 package on hex.pm</a> so that other people can deal with a struct of config data.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">bus</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;i2c-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="nc">ADS1115</span><span class="o">.</span><span class="n">config</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">72</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">=&gt;</span> <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">%</span><span class="nc">ADS1115.Config</span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="ss">performing_conversion</span><span class="p">:</span> <span class="no">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">mux</span><span class="p">:</span> <span class="p">{</span><span class="ss">:ain0</span><span class="p">,</span> <span class="ss">:ain1</span><span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="ss">gain</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">mode</span><span class="p">:</span> <span class="ss">:single_shot</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">data_rate</span><span class="p">:</span> <span class="mi">128</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">comp_mode</span><span class="p">:</span> <span class="ss">:traditional</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">comp_polarity</span><span class="p">:</span> <span class="ss">:active_low</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">comp_latch</span><span class="p">:</span> <span class="no">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">comp_queue</span><span class="p">:</span> <span class="ss">:disabled</span>
</span></span><span class="line"><span class="cl"><span class="p">}}</span>
</span></span></code></pre></div><p>The package also gives you an easy way to read the sensor.
Now I&rsquo;m ready to check my soil moisture sensors.</p>
<h2 id="will-this-plant-live">Will This Plant Live?</h2>
<p>Technology is no guarantee of success, but this is the best chance I have at keeping a plant alive.
I&rsquo;ll be doing some basic experiments around how much moisture different plants need and whether they like to have dry cycles, but here&rsquo;s a simplistic example of to monitor and water a plant.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">Seedling</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">GenServer</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="na">@a2d_addr</span> <span class="mi">72</span> <span class="c1"># the address of our ADS1115 analog to digital converter</span>
</span></span><span class="line"><span class="cl">  <span class="na">@check_interval</span> <span class="mi">1_000</span> <span class="c1"># wait 1000ms between checking the sensor</span>
</span></span><span class="line"><span class="cl">  <span class="na">@pump_control_pin</span> <span class="mi">4</span> <span class="c1"># the GPIO pin we are using to control our water pump</span>
</span></span><span class="line"><span class="cl">  <span class="na">@sensor_threshold</span> <span class="mi">23_989</span> <span class="c1"># a little experimenting showed that I get this reading or lower when soil is wet</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">init</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">bus</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.I2C</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&#34;i2c-1&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pump</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="na">@pump_control_pin</span><span class="p">,</span> <span class="ss">:output</span><span class="p">,</span> <span class="ss">initial_value</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">{</span><span class="n">bus</span><span class="p">,</span> <span class="n">pump</span><span class="p">},</span> <span class="na">@check_interval</span><span class="p">}</span> <span class="c1"># check the moisture in 1 second</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">handle_info</span><span class="p">(</span><span class="ss">:timeout</span><span class="p">,</span> <span class="p">{</span><span class="n">bus</span><span class="p">,</span> <span class="n">pump</span><span class="p">})</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">reading</span><span class="p">}</span> <span class="o">=</span> <span class="nc">ADS1115</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="na">@a2d_addr</span><span class="p">,</span> <span class="p">{</span><span class="ss">:ain0</span><span class="p">,</span> <span class="ss">:gnd</span><span class="p">})</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="n">reading</span> <span class="o">&gt;</span> <span class="na">@sensor_threshold</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pump</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="c1"># turn on the pump to get more water</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># Note: what happens if the sensor is un-plugged, or malfunctions, or gets moved?</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># You should probably limit the maximum amount of water you can pump in, but this</span>
</span></span><span class="line"><span class="cl">      <span class="c1"># should work for testing outside.</span>
</span></span><span class="line"><span class="cl">    <span class="k">else</span>
</span></span><span class="line"><span class="cl">      <span class="nc">Circuits.GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pump</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="c1"># turn off the pump, we got enough water</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:noreply</span><span class="p">,</span> <span class="p">{</span><span class="n">bus</span><span class="p">,</span> <span class="n">pump</span><span class="p">},</span> <span class="na">@check_interval</span><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div>

        
          <div class="blog-tags">
            
              <a href="https://embedded-elixir.com//tags/nerves/">nerves</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/elixir/">elixir</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/i2c/">i2c</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/binary/">binary</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/elixir-circuits/">elixir-circuits</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/asd1115/">ASD1115</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://embedded-elixir.com/post/2019-01-18-nerves-at-home-desk-controller/" data-toggle="tooltip" data-placement="top" title="Nerves At Home: Controlling a Desk">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://embedded-elixir.com/post/2019-08-29-nerves-at-434-mhz/" data-toggle="tooltip" data-placement="top" title="Nerves @ 434 MHz">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Curated by Frank Hunleth
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.115.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://embedded-elixir.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://embedded-elixir.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

