<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Provisioning Nerves Devices - Embedded Elixir</title>
  <meta name="description" content="Life after nerves.local">
  <meta name="author" content="Curated by Frank Hunleth"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Embedded Elixir",
    
    "url": "https:\/\/embedded-elixir.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/embedded-elixir.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/post\/2018-06-15-serial_number\/",
          "name": "Provisioning nerves devices"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Frank Hunleth"
  },
  "headline": "Provisioning Nerves Devices",
  "description" : "When you\u0026rsquo;re starting out with Nerves, you may have connected to your first projects over the network using nerves.local. Libraries like nerves_init_gadget make this easy and when you\u0026rsquo;re starting out, it\u0026rsquo;s really convenient. Don\u0026rsquo;t know the IP address that your device was assigned? Try nerves.local and you\u0026rsquo;re good to go.\nAnd then you add a second device to your network. nerves.local isn\u0026rsquo;t looking so convenient any more.\n",
  "inLanguage" : "en",
  "wordCount":  742 ,
  "datePublished" : "2018-06-15T00:00:00",
  "dateModified" : "2018-06-15T00:00:00",
  "image" : "https:\/\/embedded-elixir.com\/images\/logo.png",
  "keywords" : [ "nerves, provisioning" ],
  "mainEntityOfPage" : "https:\/\/embedded-elixir.com\/post\/2018-06-15-serial_number\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/embedded-elixir.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/embedded-elixir.com\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Provisioning Nerves Devices" />
<meta property="og:description" content="Life after nerves.local">
<meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
<meta property="og:url" content="https://embedded-elixir.com/post/2018-06-15-serial_number/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Embedded Elixir" />

  <meta name="twitter:title" content="Provisioning Nerves Devices" />
  <meta name="twitter:description" content="Life after nerves.local">
  <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://embedded-elixir.com/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.115.2">
  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://embedded-elixir.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://embedded-elixir.com/css/syntax.css" /><link rel="stylesheet" href="https://embedded-elixir.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16709386-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Newsletter" href="https://nerves-project.org/newsletter">Newsletter</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com/images/logo.png" alt="Embedded Elixir" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Provisioning Nerves Devices</h1>
              
              
              
                
                  <h2 class="post-subheading">Life after nerves.local</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on June 15, 2018
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Frank Hunleth
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>When you&rsquo;re starting out with Nerves, you may have connected to your first
projects over the network using <code>nerves.local</code>. Libraries like
<a href="https://github.com/nerves-project/nerves_init_gadget">nerves_init_gadget</a> make this easy and when you&rsquo;re
starting out, it&rsquo;s really convenient. Don&rsquo;t know the IP address that your
device was assigned? Try <code>nerves.local</code> and you&rsquo;re good to go.</p>
<p>And then you add a second device to your network. <code>nerves.local</code> isn&rsquo;t looking
so convenient any more.</p>
<h2 id="update-were-moving-to-namespacing-provisioning-variables-the-references-to-serial_number-will-eventually-change-to-nerves_serial_number-well-keep-serial_number-working-in-official-builds-though">Update: we&rsquo;re moving to namespacing provisioning variables. The references to <code>serial_number</code> will eventually change to <code>nerves_serial_number</code>. We&rsquo;ll keep <code>serial_number</code> working in official builds, though.</h2>
<p>Suffice it to say that there are a number of ways of solving this problem. This
post shows how to provision names or numbers to devices. You&rsquo;ll likely need to
provision additional information to devices and that can be done in a similar
way.</p>
<p>The first step is to decide on a way of identifying devices. Nearly every
Nerves System has a way of finding a unique identifier for a board by default.
The default is to use that number to create a unique hostname and you can see
it by running <code>:inet.gethostname()</code>. It will be something like <code>nerves-1234</code>.
(This hostname is only local unless something registers it in the DNS.
<code>nerves.local</code> is a mDNS name.) The <code>erlinit.config</code> file specifies how to
create the hostname. All of the Raspberry Pi boards have a similar setting.
Here is the one for the <a href="https://github.com/nerves-project/nerves_system_rpi3/blob/main/rootfs_overlay/etc/erlinit.config">Raspberry Pi 3</a>:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="o">-</span><span class="n">d</span> <span class="s2">&#34;/usr/bin/boardid -b uboot_env -u serial_number -b rpi -n 4&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">-</span><span class="n">n</span> <span class="n">nerves</span><span class="o">-</span><span class="err">%</span><span class="n">s</span>
</span></span></code></pre></div><p>The <code>-d</code> setting specifies how to find a unique ID. This invokes
<a href="https://github.com/fhunleth/boardid">boardid</a> to look it up. Don&rsquo;t worry about the commandline arguments
yet. The unique ID could be stored in the CPU (like on the Raspberry Pi), an
EEPROM, or a few other places depending on the board. The <code>-n</code> setting specifies
the format of the hostname where the <code>%s</code> is substituted for the identifier.</p>
<p>Getting back to the <code>boardid</code> commandline, the arguments say to use the
<code>serial_number</code> key from the U-Boot environment first or if that doesn&rsquo;t exist,
use 4 digits of the Raspberry Pi&rsquo;s serial number.</p>
<p>Nerves uses the U-Boot environment for many things, but mostly for keeping track
of the running firmware by default. You can think of it as a very simple and
small key-value store that&rsquo;s on the SDCard (if you&rsquo;re using a Raspberry Pi) but
stored outside of any of the filesystems.
<a href="https://github.com/nerves-project/nerves_runtime#nerves-system-and-firmware-metadata">Nerves.Runtime</a> documents the keys that Nerves uses. A
device doesn&rsquo;t have to run the U-Boot bootloader to have a U-Boot environment.
The format is convenient so Nerves reuses it.</p>
<p>Nerves does not make writing values to the U-Boot environment convenient to
reduce the chance of corrupting or losing data in it. Users should prefer to
store application settings and data in the Nerves application partition. The
U-Boot environment is appropriate for provisioning information that is unlikely
to change over the device&rsquo;s lifetime. The serial number of the device is
one example. To write it, attach to your Nerves device&rsquo;s console at type:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="n">iex</span><span class="o">&gt;</span> <span class="n">cmd</span><span class="p">(</span><span class="s2">&#34;fw_setenv serial_number abc123&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="ss">:ok</span>
</span></span></code></pre></div><p>Reboot and the next time the device comes up, you should be able to see the new
serial number:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="n">iex</span><span class="o">&gt;</span> <span class="nc">Nerves.Runtime.KV</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&#34;serial_number&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="s2">&#34;abc123&#34;</span>
</span></span><span class="line"><span class="cl"><span class="nc">Iex</span><span class="o">&gt;</span> <span class="ss">:inet</span><span class="o">.</span><span class="n">gethostname</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="s1">&#39;nerves-abc123&#39;</span><span class="p">}</span>
</span></span></code></pre></div><p>Now getting back to the original issue, how does this fix the <code>nerves.local</code>
problem? The answer is that you need to update the <code>nerves_init_gadget</code>
configuration to tell it to construct the mDNS name off of the hostname. Modify
your <code>config.exs</code> to look something like this:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="n">config</span> <span class="ss">:nerves_init_gadget</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">mdns_domain</span><span class="p">:</span> <span class="ss">:hostname</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="ss">ssh_console_port</span><span class="p">:</span> <span class="mi">22</span>
</span></span></code></pre></div><p>Rebuild and update the device. On your laptop, you should be able to <code>ping nerves-abc123.local</code> now.</p>
<h2 id="provisioning-devices-offline">Provisioning devices offline</h2>
<p>Imagine that you need to make SDCards for a lot of devices. Logging on to the
console to set the serial number on each device will get old quick. You can
program the serial number at the same time that you&rsquo;re burning the SDCard.
Instead of using <code>mix firmware.burn</code>, it is easier to call <code>fwup</code> directly. <code>mix firmware.burn</code> is a minimal wrapper on <code>fwup</code> anyway.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">sudo <span class="nv">SERIAL_NUMBER</span><span class="o">=</span>abc123 fwup ./_build/rpi3/dev/nerves/images/myproj.fw
</span></span></code></pre></div><p>If you&rsquo;re wondering how this works, look for the following line in your system&rsquo;s
<code>fwup.conf</code> file:</p>
<pre tabindex="0"><code class="language-config" data-lang="config">uboot_setenv(uboot-env, &#34;serial_number&#34;, &#34;\${SERIAL_NUMBER}&#34;)
</code></pre><h2 id="security">Security</h2>
<p>The U-Boot environment block is stored in the clear on the SDCard and is
accessible via Nerves.Runtime.KV. The data isn&rsquo;t authenticated and tools are
readily available to modify it. Since you&rsquo;ll be tempted to provision secret key
material in the U-Boot environment block, please review the security
ramifications of that decision before doing so.</p>

        
          <div class="blog-tags">
            
              <a href="https://embedded-elixir.com//tags/nerves/">nerves</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/provisioning/">provisioning</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://embedded-elixir.com/post/2018-05-03-nerves-v1.0.0/" data-toggle="tooltip" data-placement="top" title="Nerves v1.0 Released">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://embedded-elixir.com/post/2018-09-25-mocks-and-explicit-contracts-expansion/" data-toggle="tooltip" data-placement="top" title="Mocks and Explicit Contracts in Nerves">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Curated by Frank Hunleth
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.115.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://embedded-elixir.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://embedded-elixir.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

