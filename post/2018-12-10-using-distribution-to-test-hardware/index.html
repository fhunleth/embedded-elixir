<!DOCTYPE html>
<html lang="en" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Using Erlang Distribution to test hardware - Embedded Elixir</title>
  <meta name="description" content="Not just for distributed networks">
  <meta name="author" content="Curated by Frank Hunleth"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "Embedded Elixir",
    
    "url": "https:\/\/embedded-elixir.com\/"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/embedded-elixir.com\/"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/embedded-elixir.com\/post\/2018-12-10-using-distribution-to-test-hardware\/",
          "name": "Using erlang distribution to test hardware"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "Connor Rigby"
  },
  "headline": "Using Erlang Distribution to test hardware",
  "description" : "Iterating quickly over code changes when working with new hardware can be tricky. Nerves has built-in mechanisms that can be helpful, but what if there were an even faster, more efficient way?\n",
  "inLanguage" : "en",
  "wordCount":  1476 ,
  "datePublished" : "2018-12-10T00:00:00",
  "dateModified" : "2018-12-10T00:00:00",
  "image" : "https:\/\/embedded-elixir.com\/images\/logo.png",
  "keywords" : [ "nerves, erlang, distribution" ],
  "mainEntityOfPage" : "https:\/\/embedded-elixir.com\/post\/2018-12-10-using-distribution-to-test-hardware\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/embedded-elixir.com\/",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/embedded-elixir.com\/images\/logo.png",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Using Erlang Distribution to test hardware" />
<meta property="og:description" content="Not just for distributed networks">
<meta property="og:image" content="https://embedded-elixir.com/images/logo.png" />
<meta property="og:url" content="https://embedded-elixir.com/post/2018-12-10-using-distribution-to-test-hardware/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="Embedded Elixir" />

  <meta name="twitter:title" content="Using Erlang Distribution to test hardware" />
  <meta name="twitter:description" content="Not just for distributed networks">
  <meta name="twitter:image" content="https://embedded-elixir.com/images/logo.png" />
  <meta name="twitter:card" content="summary_large_image" />
  <link href='https://embedded-elixir.com/images/favicon.ico' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.115.2">
  <link rel="alternate" href="https://embedded-elixir.com/index.xml" type="application/rss+xml" title="Embedded Elixir"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css" integrity="sha384-AfEj0r4/OFrOo5t7NnNe46zW/tFgW6x/bCJG8FqQCEo3+Aro6EYUG4+cU+KJWu/X" crossorigin="anonymous">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous"><link rel="stylesheet" href="https://embedded-elixir.com/css/main.css" /><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" /><link rel="stylesheet" href="https://embedded-elixir.com/css/syntax.css" /><link rel="stylesheet" href="https://embedded-elixir.com/css/codeblock.css" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.css" integrity="sha384-h/L2W9KefUClHWaty3SLE5F/qvc4djlyR4qY3NUV5HGQBBW7stbcfff1+I/vmsHh" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/default-skin/default-skin.min.css" integrity="sha384-iD0dNku6PYSIQLyfTOpB06F2KCZJAKLOThS5HRe8b3ibhdEQ6eKsFf/EeFxdOt5R" crossorigin="anonymous">

<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-16709386-6', 'auto');
	
	ga('send', 'pageview');
}
</script>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="https://embedded-elixir.com/">Embedded Elixir</a>
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li>
              <a title="Blog" href="/">Blog</a>
            </li>
          
        
          
            <li>
              <a title="Newsletter" href="https://nerves-project.org/newsletter">Newsletter</a>
            </li>
          
        
          
            <li>
              <a title="Tags" href="/tags">Tags</a>
            </li>
          
        

        

        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="Embedded Elixir" href="https://embedded-elixir.com/">
            <img class="avatar-img" src="https://embedded-elixir.com/images/logo.png" alt="Embedded Elixir" />
          </a>
        </div>
      </div>
    

  </div>
</nav>




    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  

  <header class="header-section ">
    
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Using Erlang Distribution to test hardware</h1>
              
              
              
                
                  <h2 class="post-subheading">Not just for distributed networks</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;Posted on December 10, 2018
  
  
  
  
    
      &nbsp;|&nbsp;<i class="fas fa-user"></i>&nbsp;Connor Rigby
    
  
  
</span>


              
            </div>
          </div>
        </div>
      </div>
    </div>
  
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <article role="main" class="blog-post">
        <p>Iterating quickly over code changes when working with new hardware can be
tricky. Nerves has built-in mechanisms that can be helpful, but what if there
were an even faster, more efficient way?</p>
<h2 id="the-problem">The problem</h2>
<p>Imagine you are writing code that targets a specific piece of hardware. For
this basic example, lets assume you have a button attached to a pin on a Nerves
powered device.</p>
<p>You want to iterate quickly over your code. It&rsquo;s early days and you don&rsquo;t know
<em>exactly</em> what your modules will look like. You know you need to turn the LED
on but are unsure of how to do this right now.</p>
<h2 id="solution-1-the-intuitive-solution">Solution 1: The &ldquo;intuitive&rdquo; solution</h2>
<p>This will be one way to accomplish what you are after. I will outline basic
steps below:</p>
<ol>
<li>
<p>write code</p>
</li>
<li>
<p><code>mix firmware</code></p>
</li>
<li>
<p><code>mix firmware.burn</code> or <code>mix firmware.push</code></p>
</li>
<li>
<p>(only if used <code>firmware.burn</code>) insert SDCard + power</p>
</li>
<li>
<p>(only if used <code>firmware.push</code>) wait for reboot</p>
</li>
<li>
<p>test changes</p>
</li>
<li>
<p>back to step 1</p>
</li>
</ol>
<h3 id="pros-to-the-intuitive-solution">Pros to the &ldquo;intuitive&rdquo; solution</h3>
<ol>
<li>It is <em>relatively</em> quick.</li>
</ol>
<p>On my machine building + pushing firmware takes about 1.5 minutes all in all,
then waiting for boot is another minute or so depending on the complexity of
the application. Say 2 minutes to start to finish. Note this is the same for
one single character change, or an entire rewrite of your module/application.</p>
<ol start="2">
<li>It is simple.</li>
</ol>
<p>This is about the easiest thing one could understand. Change code, push code,
reboot. No complexity added to code.</p>
<h3 id="cons-to-the-intuitive-solution">Cons to the &ldquo;intuitive&rdquo; solution</h3>
<ol>
<li>it could be quicker.</li>
</ol>
<p>2 minutes seems fast to push an update, until you are in a position where you
are doing tons of iteration. Waiting 2 minutes to test out a one line change is
a ton of time spent waiting. <a href="https://xkcd.com/303/">Relevant XKCD Comic</a>.</p>
<ol start="2">
<li>it&rsquo;s inefficient.</li>
</ol>
<p>You only changed one line? why should you have to wait for an entire update
<em>AND</em> a reboot for that?</p>
<h2 id="solution-2-the-raspbian-solution">Solution 2: The &ldquo;Raspbian&rdquo; Solution</h2>
<p>This is another common way to bootstrap an application or feature.  Basically,
you spin up a version of
<a href="https://www.raspberrypi.org/downloads/raspbian/">Raspbian</a> or similar distro
on your device such as plain <a href="https://beagleboard.org/latest-images">Debian on Beagle based
boards</a>.  I&rsquo;ll outline the steps to this
one:</p>
<ol>
<li>
<p>Install OS.</p>
</li>
<li>
<p>Connect to OS via ssh, keyboard+mouse, UART etc.</p>
</li>
<li>
<p>configure/update OS (one time only if you keep the SDCard handy).</p>
</li>
<li>
<p>get code onto OS.</p>
</li>
<li>
<p>edit code.</p>
</li>
<li>
<p>test code.</p>
</li>
<li>
<p>back to step 5.</p>
</li>
</ol>
<h3 id="pros-of-the-raspbian-solution">Pros of the &ldquo;Raspbian&rdquo; Solution</h3>
<ol>
<li>After initial setup it can be quick</li>
</ol>
<p>After you&rsquo;ve got your OS up and running and configured, iteration is pretty
fast, as long as you can make changes quickly.</p>
<ol start="2">
<li>It&rsquo;s good for testing hardware</li>
</ol>
<p>A lot of sensors/hats/hardware has libraries that expect you to be using the
standard OS for your device. Libraries are often written in languages such as
Python, and may require porting to Elixir to work with Nerves easily. Testing
on the standard OS is a good way to test out hardware and check which
dependencies might be needed for Nerves.</p>
<h3 id="cons-of-the-raspbian-solution">Cons of the &ldquo;Raspbian&rdquo; Solution</h3>
<ol>
<li>It&rsquo;s awkward to setup</li>
</ol>
<p>Getting up and running can be easy, but bloated OS makes it take a long time,
you need to know OS tools to get connected.</p>
<ol start="2">
<li>It&rsquo;s awkward to use</li>
</ol>
<p>Even after getting up and running, using this solution is hard.  You need to be
connected directly to the device, to write code and test it. Most of these
devices aren&rsquo;t quite powerful enough to run a web browser, or you aren&rsquo;t using
a desktop environment at all, so you need a way of reading docs on a different
machine, or loading them a different way. Copying examples from a web browser
is a no-go if not using SSH or UART. If using SSH or UART, you won&rsquo;t have a
visual text editor.</p>
<h2 id="solution-3-the-erlang-solution">Solution 3: The &ldquo;Erlang&rdquo; Solution</h2>
<p>Since Nerves is built on top of Erlang and OTP, we have the ability to get the
best of both worlds. By design Erlang has the following built into the
language:</p>
<ul>
<li>Hot code reloading</li>
<li>Remote code loading</li>
</ul>
<p>This solves both of the issues with the &ldquo;intuitive&rdquo; solution. Code can be
reloaded in real time without pushing a new update, and without a reboot. Your
iteration is now only limited to how fast it can be tested.  I&rsquo;ll outline the
steps to this one:</p>
<ol>
<li>
<p>build/push firmware. Same as steps 1-3 of the &ldquo;Intuitive&rdquo; solution.
but it only needs to be done once.</p>
</li>
<li>
<p>Edit code.</p>
</li>
<li>
<p>load code.</p>
</li>
<li>
<p>test code.</p>
</li>
<li>
<p>back to step 2.</p>
</li>
</ol>
<h3 id="pros-of-the-erlang-solution">Pros of the &ldquo;Erlang&rdquo; Solution</h3>
<ol>
<li>It&rsquo;s Instant</li>
</ol>
<p>Code can be reloaded and tested as fast as you can type it. (well almost)
Reloading an OTP app takes about 3 seconds for my machine.</p>
<ol start="2">
<li>It keeps you on the &ldquo;host&rdquo; machine as much as possible</li>
</ol>
<p>When implemented properly, you will be pressed to find a reason to actually
connect directly to your device to investigate things.</p>
<h3 id="cons-of-the-erlang-solution">Cons of the &ldquo;Erlang&rdquo; Solution</h3>
<ol>
<li>It&rsquo;s more complex than other solutions</li>
</ol>
<p>This solution requires you to actively write code in a way that can work this
way. It&rsquo;s not that bad once you get the hang of it.</p>
<ol start="2">
<li>It&rsquo;s not compatible with all libraries.</li>
</ol>
<p>Since it requires code to be written in a particular way, this solution has
some issues working with some libraries. This turns out to not really be a huge
problem in practice however.</p>
<ol start="3">
<li>It only works for Erlang/Elixir code.</li>
</ol>
<p>This solution will not work for data that winds up in the <code>priv</code> directory,
such as C ports/nifs, eex templates, etc.</p>
<h2 id="implementing-the-erlang-solution">Implementing the &ldquo;Erlang&rdquo; Solution</h2>
<p>Implementing this solution isn&rsquo;t as simple as adding a dependency. It requires
you to write your code in a way that is compatible.  I&rsquo;m assuming you already
have an application scaffolded with <code>mix nerves.new</code> and it already has
<code>nerves_init_gadget</code> configured and working properly.</p>
<p>Looking back at our problem, let&rsquo;s start with toggling an LED.</p>
<p>Add <code>{:elixir_ale, &quot;~&gt; 1.2&quot;}</code> to your deps (not just your target deps), and
push firmware to your device.</p>
<p>Consulting the <a href="https://hexdocs.pm/elixir_ale/ElixirALE.GPIO.html">gpio docs</a>
we can see that we need to call <code>GPIO.start_link/3</code> to start a GPIO connection,
but that will start a <code>pid</code> locally on your host machine if you try it. But
turns out Erlang has the solution built in:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">MyApp.LEDs</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="na">@moduledoc</span> <span class="sh">&#34;&#34;&#34;
</span></span></span><span class="line"><span class="cl"><span class="sh">  Control some LEDs
</span></span></span><span class="line"><span class="cl"><span class="sh">  &#34;&#34;&#34;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kn">alias</span> <span class="nc">ElixirALE.GPIO</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">toggle</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">pid</span><span class="p">}</span> <span class="o">=</span> <span class="n">start_gpio</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="ss">:output</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span> <span class="o">=</span> <span class="nc">GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Process</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="n">time</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="ss">:ok</span> <span class="o">=</span> <span class="nc">GPIO</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nc">GPIO</span><span class="o">.</span><span class="n">release</span><span class="p">(</span><span class="n">pid</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">case</span> <span class="nc">Mix.Project</span><span class="o">.</span><span class="n">config</span><span class="p">()[</span><span class="ss">:target</span><span class="p">]</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;host&#34;</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">defp</span> <span class="n">start_gpio</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># :&#34;my_app@nerves.local&#34; is the node name of your Nerves</span>
</span></span><span class="line"><span class="cl">        <span class="c1"># device. See `nerves_init_gadget` docs for more info.</span>
</span></span><span class="line"><span class="cl">        <span class="ss">:rpc</span><span class="o">.</span><span class="n">call</span><span class="p">(</span><span class="ss">:&#34;my_app@nerves.local&#34;</span><span class="p">,</span> <span class="nc">GPIO</span><span class="p">,</span> <span class="ss">:start_link</span><span class="p">,</span> <span class="p">[</span><span class="n">pin</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">opts</span><span class="p">])</span>
</span></span><span class="line"><span class="cl">      <span class="k">end</span>
</span></span><span class="line"><span class="cl">    <span class="n">_</span> <span class="o">-&gt;</span>
</span></span><span class="line"><span class="cl">      <span class="kd">defp</span> <span class="n">start_gpio</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">opts</span> <span class="p">\\</span> <span class="p">[])</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">        <span class="nc">GPIO</span><span class="o">.</span><span class="n">start_link</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">opts</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">      <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>and on our host machine if we try it out:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iex -S mix
</span></span><span class="line"><span class="cl">MyApp.LEDs.toggle<span class="o">(</span>16, 100<span class="o">)</span>
</span></span><span class="line"><span class="cl">** <span class="o">(</span>MatchError<span class="o">)</span> no match of right hand side value: <span class="o">{</span>:badrpc, :nodedown<span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">(</span>remote_io<span class="o">)</span> lib/mix/my_app/leds.ex:9: MyApp.LEDs.toggle/2
</span></span></code></pre></div><p>What happened? Well Our host machine isn&rsquo;t connected to our device, so we get
an error saying <code>:nodedown</code>. We will have to setup distribution on the <code>host</code>
machine only. In <code>application.ex</code> we should have a scaffolded function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl">  <span class="c1"># ...</span>
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">children</span><span class="p">(</span><span class="s2">&#34;host&#34;</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="c1"># ...</span>
</span></span></code></pre></div><p>Lets add something to that function:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">children</span><span class="p">(</span><span class="s2">&#34;host&#34;</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="ss">:host_machine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This cookie can be found in `rel/vm.args`</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Node</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="ss">:lyclzfysmqcpj5xwxwqnlkvvlda2ukrbswalcfqm45jgikhza65xzechthr7qd7r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="no">true</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="ss">:&#34;my_app@nerves.local&#34;</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">[]</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span></code></pre></div><p>This starts distribution and should connect to your device. Now on your host
machine try it again:</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-sh" data-lang="sh"><span class="line"><span class="cl">iex -S mix
</span></span><span class="line"><span class="cl">Erlang/OTP <span class="m">21</span> <span class="o">[</span>erts-10.0.4<span class="o">]</span> <span class="o">[</span>source<span class="o">]</span> <span class="o">[</span>64-bit<span class="o">]</span> <span class="o">[</span>smp:4:4<span class="o">]</span> <span class="o">[</span>ds:4:4:10<span class="o">]</span> <span class="o">[</span>async-threads:1<span class="o">]</span> <span class="o">[</span>hipe<span class="o">]</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Interactive Elixir <span class="o">(</span>1.7.3<span class="o">)</span> - press Ctrl+C to <span class="nb">exit</span> <span class="o">(</span><span class="nb">type</span> h<span class="o">()</span> ENTER <span class="k">for</span> <span class="nb">help</span><span class="o">)</span>
</span></span><span class="line"><span class="cl">iex<span class="o">(</span>host_machine@hostname.lan<span class="o">)</span>1&gt; MyApp.LEDs.toggle<span class="o">(</span>13, 1000<span class="o">)</span>
</span></span><span class="line"><span class="cl">:ok
</span></span></code></pre></div><p>You should see your led turn on and back off a second later. And the best part?
You didn&rsquo;t need to do any firmware building, burning or pushing. Want to try it
again with a different amount of time? Just change the file, <code>recompile</code> and
try again.</p>
<p>So now your LED flashes for exactly how long you want, and you&rsquo;re ready to push
it out? Well you <em>could</em> build firmware and push it, but we can do this a bit
faster.</p>
<p>Create a new file in your project called <code>lib/mix/tasks/firmware.reload.ex</code></p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-elixir" data-lang="elixir"><span class="line"><span class="cl"><span class="kd">defmodule</span> <span class="nc">Mix.Tasks.Firmware.Reload</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">  <span class="kn">use</span> <span class="nc">Mix.Task</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">def</span> <span class="n">run</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">    <span class="n">node_name</span> <span class="o">=</span> <span class="ss">:&#34;my_app@nerves.local&#34;</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">_</span><span class="p">}</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="ss">:host_machine</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="c1"># This cookie can be found in `rel/vm.args`</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Node</span><span class="o">.</span><span class="n">set_cookie</span><span class="p">(</span><span class="ss">:lyclzfysmqcpj5xwxwqnlkvvlda2ukrbswalcfqm45jgikhza65xzechthr7qd7r</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="no">true</span> <span class="o">=</span> <span class="nc">Node</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">node_name</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nc">Application</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="ss">:my_app</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="n">my_app_mods</span><span class="p">}</span> <span class="o">=</span> <span class="ss">:application</span><span class="o">.</span><span class="n">get_key</span><span class="p">(</span><span class="ss">:my_app</span><span class="p">,</span> <span class="ss">:modules</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="n">module</span> <span class="o">&lt;-</span> <span class="n">my_app_mods</span> <span class="k">do</span>
</span></span><span class="line"><span class="cl">      <span class="p">{</span><span class="ss">:ok</span><span class="p">,</span> <span class="p">[{</span><span class="o">^</span><span class="n">node_name</span><span class="p">,</span> <span class="ss">:loaded</span><span class="p">,</span> <span class="o">^</span><span class="n">module</span><span class="p">}]}</span> <span class="o">=</span> <span class="nc">IEx.Helpers</span><span class="o">.</span><span class="n">nl</span><span class="p">([</span><span class="n">node_name</span><span class="p">],</span> <span class="n">module</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="k">end</span>
</span></span><span class="line"><span class="cl">  <span class="k">end</span>
</span></span><span class="line"><span class="cl"><span class="k">end</span>
</span></span></code></pre></div><p>This will reload your module in real time, and allow you to test it on the
device without need for a reboot.</p>
<h1 id="conclusion">Conclusion</h1>
<p>There is not always exactly one solution for iterating code on real hardware.
Erlang&rsquo;s built in mechanisms can allow us to iterate over code in a quick and
easy way in many circumstances. I&rsquo;ve recently adopted this method and along
with proper <a href="http://blog.plataformatec.com.br/2015/10/mocks-and-explicit-contracts/">mocking and
contracts</a>
it has proved to be an incredibly valuable tool for writing Nerves applications
quickly and efficiently.</p>

        
          <div class="blog-tags">
            
              <a href="https://embedded-elixir.com//tags/nerves/">nerves</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/erlang/">erlang</a>&nbsp;
            
              <a href="https://embedded-elixir.com//tags/distribution/">distribution</a>&nbsp;
            
          </div>
        

        

        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://embedded-elixir.com/post/2018-12-10-heart/" data-toggle="tooltip" data-placement="top" title="You Gotta Have Heart">&larr; Previous Post</a>
            </li>
          
          
            <li class="next">
              <a href="https://embedded-elixir.com/post/2019-01-18-nerves-at-home-desk-controller/" data-toggle="tooltip" data-placement="top" title="Nerves At Home: Controlling a Desk">Next Post &rarr;</a>
            </li>
          
        </ul>
      


      
        
          
          <div class="disqus-comments">
            <div id="disqus_thread"></div>
<script type="application/javascript">
    window.disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "embedded-elixir" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>
          
        
        
      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
          
        </ul>
        <p class="credits copyright text-muted">
          
            
              Curated by Frank Hunleth
            
          

          &nbsp;&bull;&nbsp;&copy;
          
            2023
          

          
            &nbsp;&bull;&nbsp;
            <a href="https://embedded-elixir.com/">Embedded Elixir</a>
          
        </p>
        
        <p class="credits theme-by text-muted">
          <a href="https://gohugo.io">Hugo v0.115.2</a> powered &nbsp;&bull;&nbsp; Theme <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> adapted from <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
        </p>
      </div>
    </div>
  </div>
</footer><script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js" integrity="sha384-g7c+Jr9ZivxKLnZTDUhnkOnsh30B4H0rpLUpJ4jAIKs4fnJI+sEnkvrMWph2EDg4" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" integrity="sha384-mll67QQFJfxn0IYznZYonOWZ644AWYC+Pt2cHqMaRhXVrursRwvLnLaebdGIlYNa" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

<script src="https://embedded-elixir.com/js/main.js"></script><script> renderMathInElement(document.body); </script><script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe.min.js" integrity="sha384-QELNnmcmU8IR9ZAykt67vGr9/rZJdHbiWi64V88fCPaOohUlHCqUD/unNN0BXSqy" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/photoswipe/4.1.2/photoswipe-ui-default.min.js" integrity="sha384-m67o7SkQ1ALzKZIFh4CiTA8tmadaujiTa9Vu+nqPSwDOqHrDmxLezTdFln8077+q" crossorigin="anonymous"></script><script src="https://embedded-elixir.com/js/load-photoswipe.js"></script>









    
  </body>
</html>

